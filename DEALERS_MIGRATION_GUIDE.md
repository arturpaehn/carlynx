# üè¢ Dealers Functionality - Database Setup

## üìã –ß—Ç–æ –¥–æ–±–∞–≤–ª—è–µ—Ç —ç—Ç–∞ –º–∏–≥—Ä–∞—Ü–∏—è:

### 1. **–¢–∏–ø—ã –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–π**
- `individual` - –æ–±—ã—á–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å ($5 –∑–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–µ)
- `dealer` - –¥–∏–ª–µ—Ä (–ø–æ–¥–ø–∏—Å–∫–∞ $400-3000/–º–µ—Å—è—Ü –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –æ–±—ä—è–≤–ª–µ–Ω–∏–π)

### 2. **–¢–∞–±–ª–∏—Ü—ã**
- `dealers` - –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–∏–ª–µ—Ä–∞—Ö –∏ –ø–æ–¥–ø–∏—Å–∫–∞—Ö
- `dealer_subscriptions` - –∏—Å—Ç–æ—Ä–∏—è –ø–ª–∞—Ç–µ–∂–µ–π
- `subscription_tiers` - —Ç–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã

### 3. **–¢–∞—Ä–∏—Ñ–Ω—ã–µ –ø–ª–∞–Ω—ã**

| Tier | Price | Listings/month | Features |
|------|-------|----------------|----------|
| **Up to 100** | $400/mo | 100 | Verified badge |
| **Up to 250** | $800/mo | 250 | + Priority support, Analytics |
| **Up to 500** | $1,250/mo | 500 | + 10 featured listings |
| **Up to 1000** | $2,000/mo | 1000 | + 20 featured listings |
| **Unlimited** | $3,000/mo | Unlimited | + API access, Unlimited featured |

### 4. **–§—É–Ω–∫—Ü–∏–∏**
- `check_individual_listing_limit()` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –ª–∏–º–∏—Ç–æ–≤
- `reset_dealer_monthly_counters()` - —Å–±—Ä–æ—Å —Å—á—ë—Ç—á–∏–∫–æ–≤ (1-–≥–æ —á–∏—Å–ª–∞ –∫–∞–∂–¥–æ–≥–æ –º–µ—Å—è—Ü–∞)
- `update_expired_dealer_subscriptions()` - –¥–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è –ø—Ä–æ—Å—Ä–æ—á–µ–Ω–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫
- `can_user_create_listing(user_id)` - –ø—Ä–æ–≤–µ—Ä–∫–∞ –≤–æ–∑–º–æ–∂–Ω–æ—Å—Ç–∏ —Å–æ–∑–¥–∞–Ω–∏—è –ª–∏—Å—Ç–∏–Ω–≥–∞

---

## üöÄ –ö–∞–∫ –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é:

### –°–ø–æ—Å–æ–± 1: –ß–µ—Ä–µ–∑ Supabase Dashboard (—Ä–µ–∫–æ–º–µ–Ω–¥—É–µ—Ç—Å—è)

1. –û—Ç–∫—Ä—ã—Ç—å https://supabase.com/dashboard/project/kjntriyhqpfxqciaxbpj/editor
2. SQL Editor ‚Üí New Query
3. –°–∫–æ–ø–∏—Ä–æ–≤–∞—Ç—å –≤–µ—Å—å –∫–æ–¥ –∏–∑ `20250103_add_dealers_functionality.sql`
4. –í—Å—Ç–∞–≤–∏—Ç—å –∏ –Ω–∞–∂–∞—Ç—å **"Run"**
5. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ –≤—ã–ø–æ–ª–Ω–∏–ª–æ—Å—å –±–µ–∑ –æ—à–∏–±–æ–∫

### –°–ø–æ—Å–æ–± 2: –ß–µ—Ä–µ–∑ Supabase CLI

```powershell
# –ï—Å–ª–∏ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω Supabase CLI
supabase db push

# –ò–ª–∏ –Ω–∞–ø—Ä—è–º—É—é –ø—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é
psql <connection-string> < supabase/migrations/20250103_add_dealers_functionality.sql
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ—Å–ª–µ –º–∏–≥—Ä–∞—Ü–∏–∏:

### 1. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞–±–ª–∏—Ü—ã

```sql
-- –î–æ–ª–∂–Ω—ã –ø–æ—è–≤–∏—Ç—å—Å—è –Ω–æ–≤—ã–µ —Ç–∞–±–ª–∏—Ü—ã
SELECT table_name FROM information_schema.tables 
WHERE table_schema = 'public' 
AND table_name IN ('dealers', 'dealer_subscriptions', 'subscription_tiers');
```

### 2. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å –∫–æ–ª–æ–Ω–∫—É user_type

```sql
-- –î–æ–ª–∂–Ω–∞ –ø–æ—è–≤–∏—Ç—å—Å—è –∫–æ–ª–æ–Ω–∫–∞ user_type –≤ profiles
SELECT column_name, data_type, column_default 
FROM information_schema.columns 
WHERE table_name = 'profiles' AND column_name = 'user_type';
```

### 3. –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —Ç–∞—Ä–∏—Ñ—ã

```sql
-- –î–æ–ª–∂–Ω–æ –±—ã—Ç—å 3 —Ç–∞—Ä–∏—Ñ–∞
SELECT tier_id, tier_name, monthly_price, listing_limit 
FROM subscription_tiers;
```

Expected output:
```
tier_id    | tier_name         | monthly_price | listing_limit
-----------|-------------------|---------------|---------------
basic      | Basic Dealer      | 50.00         | 50
premium    | Premium Dealer    | 100.00        | NULL (unlimited)
enterprise | Enterprise Dealer | 200.00        | NULL (unlimited)
```

### 4. –¢–µ—Å—Ç —Ñ—É–Ω–∫—Ü–∏–∏ –ø—Ä–æ–≤–µ—Ä–∫–∏

```sql
-- –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ —Ñ—É–Ω–∫—Ü–∏—è —Ä–∞–±–æ—Ç–∞–µ—Ç (–∑–∞–º–µ–Ω–∏ –Ω–∞ —Ä–µ–∞–ª—å–Ω—ã–π user_id)
SELECT can_user_create_listing('–≤–∞—à-user-uuid-–∑–¥–µ—Å—å');
```

---

## üîß –ù–∞—Å—Ç—Ä–æ–π–∫–∞ Cron Jobs (–æ–ø—Ü–∏–æ–Ω–∞–ª—å–Ω–æ)

–î–ª—è –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–≥–æ —Å–±—Ä–æ—Å–∞ —Å—á—ë—Ç—á–∏–∫–æ–≤ –∏ –ø—Ä–æ–≤–µ—Ä–∫–∏ –ø–æ–¥–ø–∏—Å–æ–∫ –Ω—É–∂–Ω–æ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å cron:

### –í Supabase (—á–µ—Ä–µ–∑ pg_cron extension):

```sql
-- Enable pg_cron extension
CREATE EXTENSION IF NOT EXISTS pg_cron;

-- Reset dealer counters on 1st of each month at midnight
SELECT cron.schedule(
  'reset-dealer-counters',
  '0 0 1 * *',
  'SELECT reset_dealer_monthly_counters()'
);

-- Check expired subscriptions daily at 2 AM
SELECT cron.schedule(
  'check-expired-subscriptions',
  '0 2 * * *',
  'SELECT update_expired_dealer_subscriptions()'
);
```

### –ò–ª–∏ —á–µ—Ä–µ–∑ –≤–Ω–µ—à–Ω–∏–π —Å–µ—Ä–≤–∏—Å (Vercel Cron, GitHub Actions):

–°–æ–∑–¥–∞—Ç—å API endpoints:
- `/api/cron/reset-dealer-counters` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `reset_dealer_monthly_counters()`
- `/api/cron/check-subscriptions` ‚Üí –≤—ã–∑—ã–≤–∞–µ—Ç `update_expired_dealer_subscriptions()`

---

## üìù –°–ª–µ–¥—É—é—â–∏–µ —à–∞–≥–∏:

–ü–æ—Å–ª–µ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—è –º–∏–≥—Ä–∞—Ü–∏–∏ –Ω—É–∂–Ω–æ —Å–æ–∑–¥–∞—Ç—å:

1. **Frontend –¥–ª—è –¥–∏–ª–µ—Ä–æ–≤:**
   - [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–±–æ—Ä–∞ —Ç–∏–ø–∞ –∞–∫–∫–∞—É–Ω—Ç–∞ –ø—Ä–∏ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏
   - [ ] –§–æ—Ä–º–∞ —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏–∏ –¥–∏–ª–µ—Ä–∞ (–Ω–∞–∑–≤–∞–Ω–∏–µ –∫–æ–º–ø–∞–Ω–∏–∏ –∏ —Ç.–¥.)
   - [ ] Dashboard –¥–ª—è –¥–∏–ª–µ—Ä–æ–≤
   - [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ —É–ø—Ä–∞–≤–ª–µ–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–æ–π

2. **Stripe Integration:**
   - [ ] –°–æ–∑–¥–∞–Ω–∏–µ –ø–æ–¥–ø–∏—Å–∫–∏ —á–µ—Ä–µ–∑ Stripe
   - [ ] Webhook –¥–ª—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è —Å—Ç–∞—Ç—É—Å–∞ –ø–æ–¥–ø–∏—Å–∫–∏
   - [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ –≤—ã–±–æ—Ä–∞ —Ç–∞—Ä–∏—Ñ–Ω–æ–≥–æ –ø–ª–∞–Ω–∞

3. **UI Updates:**
   - [ ] –ë–µ–π–¥–∂ "Verified Dealer" –Ω–∞ –ª–∏—Å—Ç–∏–Ω–≥–∞—Ö
   - [ ] –°—Ç—Ä–∞–Ω–∏—Ü–∞ –∫–æ–º–ø–∞–Ω–∏–∏ –¥–∏–ª–µ—Ä–∞
   - [ ] –§–∏–ª—å—Ç—Ä "–¢–æ–ª—å–∫–æ –¥–∏–ª–µ—Ä—ã" –≤ –ø–æ–∏—Å–∫–µ

---

## üîí –ë–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç—å:

‚úÖ RLS policies –Ω–∞—Å—Ç—Ä–æ–µ–Ω—ã:
- –î–∏–ª–µ—Ä—ã –≤–∏–¥—è—Ç —Ç–æ–ª—å–∫–æ —Å–≤–æ–∏ –¥–∞–Ω–Ω—ã–µ
- –ü—É–±–ª–∏—á–Ω—ã–π –¥–æ—Å—Ç—É–ø —Ç–æ–ª—å–∫–æ –∫ –≤–µ—Ä–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω—ã–º –¥–∏–ª–µ—Ä–∞–º
- –ü–æ–¥–ø–∏—Å–∫–∏ –≤–∏–¥–Ω—ã —Ç–æ–ª—å–∫–æ –≤–ª–∞–¥–µ–ª—å—Ü—É

‚úÖ –¢—Ä–∏–≥–≥–µ—Ä—ã –ø—Ä–æ–≤–µ—Ä—è—é—Ç:
- –°—Ç–∞—Ç—É—Å –ø–æ–¥–ø–∏—Å–∫–∏ –ø–µ—Ä–µ–¥ —Å–æ–∑–¥–∞–Ω–∏–µ–º –ª–∏—Å—Ç–∏–Ω–≥–∞
- –ú–µ—Å—è—á–Ω—ã–µ –ª–∏–º–∏—Ç—ã –¥–ª—è Basic tier
- –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—á—ë—Ç—á–∏–∫–æ–≤

---

## üêõ Troubleshooting:

**–û—à–∏–±–∫–∞: "relation already exists"**
‚Üí –¢–∞–±–ª–∏—Ü–∞ —É–∂–µ —Å—É—â–µ—Å—Ç–≤—É–µ—Ç, –ø—Ä–æ–ø—É—Å—Ç–∏—Ç—å —Å–æ–∑–¥–∞–Ω–∏–µ (–º–∏–≥—Ä–∞—Ü–∏—è –±–µ–∑–æ–ø–∞—Å–Ω–∞ –¥–ª—è –ø–æ–≤—Ç–æ—Ä–Ω–æ–≥–æ –∑–∞–ø—É—Å–∫–∞)

**–û—à–∏–±–∫–∞: "function does not exist"**
‚Üí –£–±–µ–¥–∏—Ç—å—Å—è —á—Ç–æ –≤—Å–µ —Ñ—É–Ω–∫—Ü–∏–∏ —Å–æ–∑–¥–∞–Ω—ã, –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –ª–æ–≥–∏

**Cron jobs –Ω–µ —Ä–∞–±–æ—Ç–∞—é—Ç**
‚Üí –ü—Ä–æ–≤–µ—Ä–∏—Ç—å —á—Ç–æ pg_cron extension —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω
‚Üí –ò–ª–∏ –Ω–∞—Å—Ç—Ä–æ–∏—Ç—å –≤–Ω–µ—à–Ω–∏–π cron —á–µ—Ä–µ–∑ API

---

**–ì–æ—Ç–æ–≤–æ –∫ –ø—Ä–∏–º–µ–Ω–µ–Ω–∏—é!** üöÄ

–ü—Ä–∏–º–µ–Ω–∏—Ç—å –º–∏–≥—Ä–∞—Ü–∏—é —Å–µ–π—á–∞—Å –∏–ª–∏ —Å–Ω–∞—á–∞–ª–∞ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å –Ω–∞ dev –æ–∫—Ä—É–∂–µ–Ω–∏–∏?
