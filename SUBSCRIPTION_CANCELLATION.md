# üîÑ –°–∏—Å—Ç–µ–º–∞ –æ—Ç–º–µ–Ω—ã –∏ —Ä–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–æ–∫

## ‚úÖ –°—Ç–∞—Ç—É—Å: –ü–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

–í—Å—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å –æ—Ç–º–µ–Ω—ã –∏ —Ä–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏ –ø–æ–¥–ø–∏—Å–æ–∫ **—É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç**. –ö–æ–¥ –ø–æ–ª–Ω–æ—Å—Ç—å—é –≥–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é.

---

## üìã –ß—Ç–æ —É–∂–µ —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–æ

### 1. **–°—Ç—Ä–∞–Ω–∏—Ü–∞ –ø–æ–¥–ø–∏—Å–æ–∫** (`src/app/dealer/subscription/page.tsx`)

#### –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è —Ç–æ–ª—å–∫–æ –¥–ª—è –∞–∫—Ç–∏–≤–Ω—ã—Ö –ø–æ–¥–ø–∏—Å–æ–∫ (`active` –∏–ª–∏ `trial`)
- ‚úÖ –°–∫—Ä—ã–≤–∞–µ—Ç—Å—è, –µ—Å–ª–∏ –æ—Ç–º–µ–Ω–∞ —É–∂–µ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ (`cancel_at_period_end === true`)
- ‚úÖ –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ —á–µ—Ä–µ–∑ `confirm()` –ø–µ—Ä–µ–¥ –æ—Ç–º–µ–Ω–æ–π
- ‚úÖ –ü–æ–∫–∞–∑ —Å—Ç–∞—Ç—É—Å–∞ –∑–∞–≥—Ä—É–∑–∫–∏ "Canceling..."

#### –ü—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏–µ –æ –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω–æ–π –æ—Ç–º–µ–Ω–µ
- ‚úÖ –ñ—ë–ª—Ç—ã–π –±–∞–Ω–Ω–µ—Ä —Å –∏–∫–æ–Ω–∫–æ–π –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç –¥–∞—Ç—É –æ—Ç–º–µ–Ω—ã –ø–æ–¥–ø–∏—Å–∫–∏
- ‚úÖ –ö–Ω–æ–ø–∫–∞ "Reactivate Subscription" –¥–ª—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏—è
- ‚úÖ –°–æ–æ–±—â–µ–Ω–∏–µ: "–í—ã —Å–æ—Ö—Ä–∞–Ω–∏—Ç–µ –¥–æ—Å—Ç—É–ø –¥–æ –æ–∫–æ–Ω—á–∞–Ω–∏—è –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞"

#### –°–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–µ
- ‚úÖ –ó–µ–ª—ë–Ω—ã–π –±–∞–Ω–Ω–µ—Ä –ø—Ä–∏ —É—Å–ø–µ—à–Ω–æ–π –æ–ø–µ—Ä–∞—Ü–∏–∏
- ‚úÖ –ö—Ä–∞—Å–Ω—ã–π –±–∞–Ω–Ω–µ—Ä –ø—Ä–∏ –æ—à–∏–±–∫–µ
- ‚úÖ –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –ø–æ—Å–ª–µ –æ–ø–µ—Ä–∞—Ü–∏–∏

---

### 2. **API Endpoint –æ—Ç–º–µ–Ω—ã** (`/api/dealer/cancel-subscription`)

```typescript
POST /api/dealer/cancel-subscription
Body: { userId: string }
```

#### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –µ—Å—Ç—å –ª–∏ –∞–∫—Ç–∏–≤–Ω–∞—è –ø–æ–¥–ø–∏—Å–∫–∞ Stripe
2. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –Ω–µ –æ—Ç–º–µ–Ω–µ–Ω–∞ –ª–∏ —É–∂–µ –ø–æ–¥–ø–∏—Å–∫–∞
3. ‚úÖ **–ú—è–≥–∫–∞—è –æ—Ç–º–µ–Ω–∞**: `cancel_at_period_end: true` (–¥–æ—Å—Ç—É–ø –¥–æ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞)
4. ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç –ë–î:
   - `cancel_at_period_end = true`
   - `cancellation_scheduled_for = <–¥–∞—Ç–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–µ—Ä–∏–æ–¥–∞>`
5. ‚úÖ –í–æ–∑–≤—Ä–∞—â–∞–µ—Ç –¥–∞—Ç—É –æ–∫–æ–Ω—á–∞–Ω–∏—è –¥–æ—Å—Ç—É–ø–∞

#### –ü—Ä–µ–∏–º—É—â–µ—Å—Ç–≤–∞ –º—è–≥–∫–æ–π –æ—Ç–º–µ–Ω—ã:
- üü¢ –î–∏–ª–µ—Ä —Å–æ—Ö—Ä–∞–Ω—è–µ—Ç –¥–æ—Å—Ç—É–ø –¥–æ –∫–æ–Ω—Ü–∞ –æ–ø–ª–∞—á–µ–Ω–Ω–æ–≥–æ –ø–µ—Ä–∏–æ–¥–∞
- üü¢ –ú–æ–∂–Ω–æ –ø–µ—Ä–µ–¥—É–º–∞—Ç—å –∏ —Ä–µ–∞–∫—Ç–∏–≤–∏—Ä–æ–≤–∞—Ç—å
- üü¢ –°–ø—Ä–∞–≤–µ–¥–ª–∏–≤–æ: –¥–µ–Ω—å–≥–∏ —É–∂–µ –∑–∞–ø–ª–∞—á–µ–Ω—ã

---

### 3. **API Endpoint —Ä–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏** (`/api/dealer/reactivate-subscription`)

```typescript
POST /api/dealer/reactivate-subscription
Body: { userId: string }
```

#### –õ–æ–≥–∏–∫–∞ —Ä–∞–±–æ—Ç—ã:
1. ‚úÖ –ü—Ä–æ–≤–µ—Ä—è–µ—Ç, –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–∞ –ª–∏ –æ—Ç–º–µ–Ω–∞
2. ‚úÖ –û—Ç–º–µ–Ω—è–µ—Ç –∑–∞–ø–ª–∞–Ω–∏—Ä–æ–≤–∞–Ω–Ω—É—é –æ—Ç–º–µ–Ω—É: `cancel_at_period_end: false`
3. ‚úÖ –û–±–Ω–æ–≤–ª—è–µ—Ç –ë–î:
   - `cancel_at_period_end = false`
   - `cancellation_scheduled_for = null`
4. ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –ø—Ä–æ–¥–æ–ª–∂–∞–µ—Ç –¥–µ–π—Å—Ç–≤–æ–≤–∞—Ç—å –∫–∞–∫ –æ–±—ã—á–Ω–æ

---

## üéØ –ö–∞–∫ —ç—Ç–æ —Ä–∞–±–æ—Ç–∞–µ—Ç –¥–ª—è –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è

### –°—Ü–µ–Ω–∞—Ä–∏–π 1: –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏
1. –î–∏–ª–µ—Ä –∑–∞—Ö–æ–¥–∏—Ç –Ω–∞ `/dealer/subscription`
2. –í–∏–¥–∏—Ç –∫–Ω–æ–ø–∫—É **"Cancel Subscription"** –≤–Ω–∏–∑—É —Å—Ç—Ä–∞–Ω–∏—Ü—ã
3. –ù–∞–∂–∏–º–∞–µ—Ç –∫–Ω–æ–ø–∫—É ‚Üí –ü–æ—è–≤–ª—è–µ—Ç—Å—è confirm –¥–∏–∞–ª–æ–≥
4. –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–∞–µ—Ç ‚Üí –ó–∞–ø—Ä–æ—Å –∫ API
5. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –∞–∫—Ç–∏–≤–Ω–∞ –¥–æ –∫–æ–Ω—Ü–∞ –ø–µ—Ä–∏–æ–¥–∞
   - ‚úÖ –ü–æ–∫–∞–∑—ã–≤–∞–µ—Ç—Å—è –∂—ë–ª—Ç—ã–π –±–∞–Ω–Ω–µ—Ä —Å –¥–∞—Ç–æ–π –æ–∫–æ–Ω—á–∞–Ω–∏—è
   - ‚úÖ –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã –∑–∞–º–µ–Ω—è–µ—Ç—Å—è –Ω–∞ –∫–Ω–æ–ø–∫—É —Ä–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏

### –°—Ü–µ–Ω–∞—Ä–∏–π 2: –ü–µ—Ä–µ–¥—É–º–∞–ª, —Ö–æ—á—É –≤–µ—Ä–Ω—É—Ç—å –ø–æ–¥–ø–∏—Å–∫—É
1. –î–∏–ª–µ—Ä –≤–∏–¥–∏—Ç –∂—ë–ª—Ç—ã–π –±–∞–Ω–Ω–µ—Ä "Subscription will be canceled on..."
2. –ù–∞–∂–∏–º–∞–µ—Ç **"Reactivate Subscription"**
3. **–†–µ–∑—É–ª—å—Ç–∞—Ç:**
   - ‚úÖ –û—Ç–º–µ–Ω–∞ –æ—Ç–º–µ–Ω–µ–Ω–∞
   - ‚úÖ –ü–æ–¥–ø–∏—Å–∫–∞ –±—É–¥–µ—Ç –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏ –ø—Ä–æ–¥–ª–µ–Ω–∞
   - ‚úÖ –ë–∞–Ω–Ω–µ—Ä –∏—Å—á–µ–∑–∞–µ—Ç

### –°—Ü–µ–Ω–∞—Ä–∏–π 3: –ß—Ç–æ –ø—Ä–æ–∏—Å—Ö–æ–¥–∏—Ç –ø–æ—Å–ª–µ –¥–∞—Ç—ã –æ—Ç–º–µ–Ω—ã?
Stripe webhook –∞–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∏:
1. ‚úÖ –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ—Ç `subscription_status = 'canceled'`
2. ‚úÖ –î–∏–ª–µ—Ä —Ç–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø –∫ —Å–æ–∑–¥–∞–Ω–∏—é –æ–±—ä—è–≤–ª–µ–Ω–∏–π
3. ‚úÖ –°—É—â–µ—Å—Ç–≤—É—é—â–∏–µ –æ–±—ä—è–≤–ª–µ–Ω–∏—è –æ—Å—Ç–∞—é—Ç—Å—è, –Ω–æ –Ω–æ–≤—ã–µ –¥–æ–±–∞–≤–∏—Ç—å –Ω–µ–ª—å–∑—è

---

## üîß –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∏–µ –¥–µ—Ç–∞–ª–∏

### –ü–æ–ª—è –≤ —Ç–∞–±–ª–∏—Ü–µ `dealers`:
```sql
cancel_at_period_end: boolean | null
cancellation_scheduled_for: timestamp | null
stripe_subscription_id: string
subscription_status: 'trial' | 'active' | 'canceled' | 'past_due' | 'inactive'
```

### Stripe —Ñ—É–Ω–∫—Ü–∏–∏:
```typescript
// –û—Ç–º–µ–Ω–∞ –≤ –∫–æ–Ω—Ü–µ –ø–µ—Ä–∏–æ–¥–∞ (–º—è–≥–∫–∞—è)
stripe.subscriptions.update(subscriptionId, {
  cancel_at_period_end: true
})

// –†–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è
stripe.subscriptions.update(subscriptionId, {
  cancel_at_period_end: false
})

// –ñ—ë—Å—Ç–∫–∞—è –æ—Ç–º–µ–Ω–∞ (–Ω–µ–º–µ–¥–ª–µ–Ω–Ω–æ) - –ù–ï –∏—Å–ø–æ–ª—å–∑—É–µ—Ç—Å—è
stripe.subscriptions.cancel(subscriptionId)
```

---

## üìä –í–∏–∑—É–∞–ª—å–Ω—ã–µ –∏–Ω–¥–∏–∫–∞—Ç–æ—Ä—ã

### –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã:
```
–ë–µ–ª—ã–π —Ñ–æ–Ω —Å –∫—Ä–∞—Å–Ω–æ–π —Ä–∞–º–∫–æ–π
–ò–∫–æ–Ω–∫–∞ "X"
–¢–µ–∫—Å—Ç: "Cancel Subscription"
–ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏: —Å–≤–µ—Ç–ª–æ-–∫—Ä–∞—Å–Ω—ã–π —Ñ–æ–Ω
```

### –ë–∞–Ω–Ω–µ—Ä –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è:
```
–ñ—ë–ª—Ç—ã–π —Ñ–æ–Ω (yellow-50)
–ñ—ë–ª—Ç–∞—è –ª–µ–≤–∞—è –≥—Ä–∞–Ω–∏—Ü–∞ (border-l-4)
–ò–∫–æ–Ω–∫–∞ —Ç—Ä–µ—É–≥–æ–ª—å–Ω–æ–≥–æ –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
–î–∞—Ç–∞ –æ—Ç–º–µ–Ω—ã –∂–∏—Ä–Ω—ã–º —à—Ä–∏—Ñ—Ç–æ–º
```

### –ö–Ω–æ–ø–∫–∞ —Ä–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏:
```
–ñ—ë–ª—Ç—ã–π —Ñ–æ–Ω (yellow-100)
–ò–∫–æ–Ω–∫–∞ –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è (‚Üª)
–¢–µ–∫—Å—Ç: "Reactivate Subscription"
–ü—Ä–∏ –Ω–∞–≤–µ–¥–µ–Ω–∏–∏: –±–æ–ª–µ–µ —Ç—ë–º–Ω—ã–π –∂—ë–ª—Ç—ã–π
```

---

## ‚úÖ –ü—Ä–æ–≤–µ—Ä–æ—á–Ω—ã–π —Å–ø–∏—Å–æ–∫

- [x] Frontend: –ö–Ω–æ–ø–∫–∞ –æ—Ç–º–µ–Ω—ã
- [x] Frontend: –ë–∞–Ω–Ω–µ—Ä –ø—Ä–µ–¥—É–ø—Ä–µ–∂–¥–µ–Ω–∏—è
- [x] Frontend: –ö–Ω–æ–ø–∫–∞ —Ä–µ–∞–∫—Ç–∏–≤–∞—Ü–∏–∏
- [x] Frontend: –ü–æ–¥—Ç–≤–µ—Ä–∂–¥–µ–Ω–∏–µ –æ—Ç–º–µ–Ω—ã
- [x] Frontend: –°–æ–æ–±—â–µ–Ω–∏—è –æ–± —É—Å–ø–µ—Ö–µ/–æ—à–∏–±–∫–µ
- [x] API: `/api/dealer/cancel-subscription`
- [x] API: `/api/dealer/reactivate-subscription`
- [x] Stripe: –ú—è–≥–∫–∞—è –æ—Ç–º–µ–Ω–∞ (cancel_at_period_end)
- [x] Stripe: –†–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è
- [x] –ë–î: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å—Ç–∞—Ç—É—Å–∞ –æ—Ç–º–µ–Ω—ã
- [x] –ë–î: –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –¥–∞—Ç—ã –æ–∫–æ–Ω—á–∞–Ω–∏—è
- [x] Webhook: –û–±—Ä–∞–±–æ—Ç–∫–∞ –æ–∫–æ–Ω—á–∞–Ω–∏—è –ø–æ–¥–ø–∏—Å–∫–∏

---

## üß™ –ö–∞–∫ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä–æ–≤–∞—Ç—å

### 1. –û—Ç–º–µ–Ω–∞ –ø–æ–¥–ø–∏—Å–∫–∏:
```bash
# –ó–∞–π–¥–∏ –Ω–∞ —Å—Ç—Ä–∞–Ω–∏—Ü—É –ø–æ–¥–ø–∏—Å–æ–∫
http://localhost:3000/dealer/subscription

# –ù–∞–∂–º–∏ "Cancel Subscription"
# –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –ø–æ—è–≤–∏–ª—Å—è –∂—ë–ª—Ç—ã–π –±–∞–Ω–Ω–µ—Ä —Å –¥–∞—Ç–æ–π
```

### 2. –†–µ–∞–∫—Ç–∏–≤–∞—Ü–∏—è:
```bash
# –ù–∞ —Ç–æ–π –∂–µ —Å—Ç—Ä–∞–Ω–∏—Ü–µ –Ω–∞–∂–º–∏ "Reactivate Subscription"
# –ü—Ä–æ–≤–µ—Ä—å, —á—Ç–æ –±–∞–Ω–Ω–µ—Ä –∏—Å—á–µ–∑
```

### 3. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ –ë–î:
```sql
SELECT 
  user_id,
  subscription_status,
  cancel_at_period_end,
  cancellation_scheduled_for
FROM dealers
WHERE user_id = 'YOUR_USER_ID';
```

### 4. –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤ Stripe Dashboard:
1. –ó–∞–π–¥–∏ –Ω–∞ https://dashboard.stripe.com/test/subscriptions
2. –ù–∞–π–¥–∏ –ø–æ–¥–ø–∏—Å–∫—É –¥–∏–ª–µ—Ä–∞
3. –ü—Ä–æ–≤–µ—Ä—å –ø–æ–ª–µ "Cancel at period end"

---

## üéâ –ò—Ç–æ–≥

**–í—Å—è —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å "Cancel anytime" –ø–æ–ª–Ω–æ—Å—Ç—å—é —Ä–µ–∞–ª–∏–∑–æ–≤–∞–Ω–∞ –∏ –≥–æ—Ç–æ–≤–∞ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!**

–ù–µ –Ω—É–∂–Ω–æ –Ω–∏—á–µ–≥–æ –¥–æ–±–∞–≤–ª—è—Ç—å - –∫–æ–¥ —É–∂–µ —Ä–∞–±–æ—Ç–∞–µ—Ç. –ü—Ä–æ—Å—Ç–æ –ø—Ä–æ—Ç–µ—Å—Ç–∏—Ä—É–π –µ–≥–æ.
